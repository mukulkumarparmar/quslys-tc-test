name: Qualys IAC Scan

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '*/5 * * * *'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  Qualys_iac_scan:
    runs-on: ubuntu-latest
    name: Qualys IaC Scan
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Qualys IaC Scan
        uses: Qualys/github_action_qiac@main
        id: qiac
        env:
          URL: ${{ secrets.URL }}
          UNAME: ${{ secrets.USERNAME }}
          PASS: ${{ secrets.PASSWORD }}
        # with:
        #   directory: 'path of directory to scan (optional)'

      # 🔍 Detect SARIF file dynamically
      - name: Find SARIF file
        id: find_sarif
        run: |
          echo "Searching for SARIF files in workspace..."
          find ${{ github.workspace }} -type f -name "*.sarif" || true
          file_path=$(find ${{ github.workspace }} -type f -name "*.sarif" | head -n 1)
          if [ -z "$file_path" ]; then
            echo "No SARIF file found!"
          else
            echo "Found SARIF file at: $file_path"
            echo "sarif_path=$file_path" >> $GITHUB_OUTPUT
          fi

      # 🧠 Upload SARIF to GitHub Security tab (Code Scanning)
      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always() && steps.find_sarif.outputs.sarif_path != ''
        with:
          sarif_file: ${{ steps.find_sarif.outputs.sarif_path }}

      # 💾 Upload SARIF as downloadable artifact
      - name: Upload SARIF file for download
        uses: actions/upload-artifact@v4
        if: always() && steps.find_sarif.outputs.sarif_path != ''
        with:
          name: qualys-iac-sarif
          path: ${{ steps.find_sarif.outputs.sarif_path }}
          if-no-files-found: warn
