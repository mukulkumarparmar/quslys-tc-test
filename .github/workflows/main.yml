name: Qualys IaC Scan

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '*/5 * * * *'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  Qualys_iac_scan:
    runs-on: ubuntu-latest
    name: Qualys IaC Scan

    steps:
      # Step 1: Checkout repository
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Run Qualys IaC Scan
      - name: Run Qualys IaC Scan
        uses: Qualys/github_action_qiac@main
        id: qiac
        env:
          URL: ${{ secrets.URL }}
          UNAME: ${{ secrets.USERNAME }}
          PASS: ${{ secrets.PASSWORD }}
        # Optional: specify a subdirectory if your IaC files are not in repo root
        # with:
        #   directory: 'infra/'

      # Step 3: Debug â€” list workspace files to verify SARIF location
      - name: List files after scan
        if: always()
        run: |
          echo "=== Files generated by Qualys IaC Scan ==="
          ls -R ${{ github.workspace }}

      # Step 4: Upload SARIF to GitHub Code Scanning tab
      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: |
            qualys_iac_scan_results.sarif
            response.sarif
            ./output/response.sarif

      # Step 5: Upload SARIF as downloadable artifact
      - name: Upload SARIF file for download
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: qualys-iac-sarif-${{ github.run_number }}
