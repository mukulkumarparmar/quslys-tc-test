name: Qualys IAC Scan

on:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  Qualys_iac_scan:
    runs-on: ubuntu-latest
    name: Qualys IaC Scan

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2️⃣ Run Qualys IaC Scan
      - name: Run Qualys IaC Scan
        uses: Qualys/github_action_qiac@main
        id: qiac
        env:
          URL: ${{ secrets.URL }}
          UNAME: ${{ secrets.USERNAME }}
          PASS: ${{ secrets.PASSWORD }}
        # Optional: uncomment if your IaC code is in a subfolder
        # with:
        #   directory: 'iac/'

      # 3️⃣ Find SARIF file dynamically
      - name: Locate SARIF file
        id: find_sarif
        run: |
          echo "Searching for SARIF files..."
          FOUND_FILE=$(find ${{ github.workspace }} -type f -name "*.sarif" | head -n 1)
          if [ -z "$FOUND_FILE" ]; then
            echo "No SARIF file found!"
            exit 1
          fi
          echo "Found SARIF file at: $FOUND_FILE"
          echo "sarif_path=$FOUND_FILE" >> $GITHUB_OUTPUT

      # 4️⃣ Upload to GitHub Security tab
      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: ${{ steps.find_sarif.outputs.sarif_path }}

      # 5️⃣ Upload as downloadable artifact
      - name: Upload SARIF artifact for download
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: qualys-iac-sarif-${{ github.run_number }}
          path: ${{ steps.find_sarif.outputs.sarif_path }}
          if-no-files-found: error
