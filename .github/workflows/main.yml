name: Qualys IaC Scan

on:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  Qualys_iac_scan:
    runs-on: ubuntu-latest
    name: Qualys IaC Scan

    steps:
      # Step 1️⃣: Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2️⃣: Run Qualys IaC Scan
      - name: Run Qualys IaC Scan
        uses: Qualys/github_action_qiac@main
        id: qiac
        env:
          URL: ${{ secrets.URL }}
          UNAME: ${{ secrets.USERNAME }}
          PASS: ${{ secrets.PASSWORD }}

      # Step 3️⃣: Locate SARIF file dynamically across runner (broader search)
      - name: Locate SARIF file
        id: find_sarif
        run: |
          echo "Searching for SARIF file in runner..."
          FOUND_FILE=$(find /home/runner -type f -name "*.sarif" | head -n 1)
          if [ -z "$FOUND_FILE" ]; then
            echo "SARIF file not found!"
            exit 1
          fi
          echo "✅ Found SARIF file at: $FOUND_FILE"
          echo "sarif_path=$FOUND_FILE" >> $GITHUB_OUTPUT

      # Step 4️⃣: Upload SARIF to GitHub Security tab (Code Scanning)
      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: ${{ steps.find_sarif.outputs.sarif_path }}

      # Step 5️⃣: Upload SARIF as downloadable artifact
      - name: Upload SARIF file for download
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: qualys-iac-sarif-${{ github.run_number }}
          path: ${{ steps.find_sarif.outputs.sarif_path }}
          if-no-files-found: error
