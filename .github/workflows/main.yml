name: Qualys IAC Scan

on:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  Qualys_iac_scan:
    runs-on: ubuntu-latest
    name: Qualys IaC Scan
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Qualys IaC Scan
        uses: Qualys/github_action_qiac@main
        id: qiac
        env:
          URL: ${{ secrets.URL }}
          UNAME: ${{ secrets.USERNAME }}
          PASS: ${{ secrets.PASSWORD }}
        with:
          output_format: sarif           # üëà forces SARIF output
          output_file: response.sarif    # üëà explicitly name SARIF file
          # directory: 'path of directory to scan (optional)'

      # üîç Verify and move SARIF file (if it exists)
      - name: Move SARIF file to workspace
        run: |
          echo "Searching for SARIF file..."
          find /home/runner -type f -name "*.sarif" | tee /tmp/sarif_list.txt
          file_path=$(head -n 1 /tmp/sarif_list.txt || true)
          if [ -z "$file_path" ]; then
            echo "‚ùå No SARIF file found!"
          else
            echo "‚úÖ Found SARIF file at: $file_path"
            cp "$file_path" "${{ github.workspace }}/response.sarif"
          fi

      # üß† Upload to GitHub Security tab (Code Scanning Alerts)
      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: ${{ github.workspace }}/response.sarif

      # üíæ Upload as downloadable artifact
      - name: Upload SARIF file for download
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: qualys-iac-sarif
          path: ${{ github.workspace }}/response.sarif
          if-no-files-found: warn
